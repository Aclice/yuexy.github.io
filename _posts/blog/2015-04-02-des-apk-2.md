---
layout: post
title: 安卓apk文件动态加载（二）
description: 貌似这个坑放了好久了，所以今天打算来填上 Orz
category: blog
---

上次说道要用DexClassLoader来加载apk文件中的类，并且用反射机制来运行，所以这一次来深入的说一下关于生命周期的问题还有资源加载的问题。

## Activity的生命周期

可能各位大大注意到了，之前一直说的都是加载apk文件中的类并没有说是Activity。是因为，我们只能从apk文件中加载一个类，也就是Class类型，并不能确切的知道这是一个啥类型的东西，更何况所有的Activity是由AmS来统一调度的，暂时不想去纠结安卓内核的话，就需要自己来管理插件的生命周期。

首先我们要想到，假如宿主程序中需要管理插件的生命周期的话，也就是要控制插件中的各个回调方法，需要确保插件中确实有这几个方法，所以需要用一个Interface来规范它的行为。

其次，要是所有的回调函数都需要最终的插件Activity来实现一次未免太麻烦，以及需要在插件的Activity中包含一个Activity类型的对象指向宿主的代理Activity（因为插件中需要调用一些跟Context有关的东西，而它本身并不能作为一个Context来使用），所以需要写一个对于上述接口的实现类，这个实现类首先是Activity的子类，重写掉n多的回调方法，并在需要调用context有关方法的时候使用传入的宿主Activity作为要使用的context。其实个人觉得这里这个类并不一定是Activity的子类，因为作为插件来说我们并不关心其类型，但是因为需要调用PackageInfo.activities来获取Activity的路径，所以最好还是使用Activity的子类。

最后在宿主程序的Activity中有一个上述的接口类型的对象使之和插件Activity绑定，然后在宿主Activity的回调方法的每一步都调用接口中的方法。


## 资源问题

AssetManager